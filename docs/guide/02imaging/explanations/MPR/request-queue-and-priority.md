---
title: 请求队列与优先级调度 
---
# 请求队列与优先级调度 

MPR 管理器通过 `_requestQueue` 管理待处理的纹理请求，并为每个请求分配优先级。优先级越高的请求越早处理。

## 请求结构

内部类 `TextureRequest` 包含:平面类型、索引、优先级、窗宽窗位值、缓存键、回调和请求时间戳。这些信息用于排序和超时判断。

## 更新优先级

当窗宽窗位或当前索引变化时，调用 `UpdateRequestPriorities()` 遍历队列并重新计算每个请求的优先级。优先级计算由 `CalculatePriority()` 完成:

* 当前切片周围的索引优先级更高。
* 对于轴向切片，距离小于 5 的请求优先级为 0.8，距离 5–9 为 0.6，其他为 0.4。
* 矢状和冠状面的阈值则更小。

重新计算后会根据优先级降序重新排序队列。

## 添加高优先级请求

每次更新索引或窗宽窗位后，`AddHighPriorityRequests()` 会将当前三个平面的索引加入队列，并设置较高的初始优先级。

## 超时与去重

在处理队列时，如果某个请求等待时间超过 30 秒且不是当前显示的切片，会被丢弃。同时，`_pendingRequests` 用于避免重复加入相同键的请求。