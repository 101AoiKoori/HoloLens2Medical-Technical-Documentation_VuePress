# DICOM 序列加载流程

## 功能思路

`LoadSeriesCoroutine()` 是加载过程的核心协程，它驱动整个 DICOM 序列的解析和组装【411489762169824†L15-L45】。该协程先读取索引列表，然后对每个条目执行一系列操作：读取文件数据、解析数据集、验证、提取像素、创建切片、更新进度，最后整理结果并触发事件。

## 原理拆解

1. **准备阶段**：更新进度到 5%，状态描述为“读取索引文件”，然后启动索引读取协程【411489762169824†L15-L20】。索引为空时直接失败并退出【411489762169824†L20-L24】。
2. **遍历加载**：
   - 计算总切片数，并初始化成功/失败计数【411489762169824†L29-L33】。
   - 对每个路径：
     1. 调用 `GetFullPath()` 生成完整 URI【411489762169824†L36-L38】。
     2. 使用 `ReadFileBytesCoroutine()` 读取二进制内容，如果读取失败则计入失败并继续【411489762169824†L40-L50】。
     3. 在 `using` 块中通过 `DicomFile.Open()` 解析数据集，并调用 `IsValidDicomDataset()` 进行基本验证【411489762169824†L53-L67】。验证不通过则跳过。
     4. 提取第一帧像素数据【411489762169824†L69-L76】。像素数据为空也视为失败。
     5. 克隆数据集并创建 `DicomSlice`，添加到目标序列【411489762169824†L91-L101】。
   - 每处理五个文件或到最后一个文件时，计算一个线性插值的进度值(40%–90% 区间)，并更新状态字符串，包括成功数和失败数【411489762169824†L104-L109】。
3. **结果整理与验证**：
   - 如果没有加载到任何切片，则报告失败【411489762169824†L114-L117】。
   - 调用 `SortSlices()` 对切片按位置排序，并更新进度到 90%【411489762169824†L120-L122】。
   - 设置体积属性并将进度更新到 95%【411489762169824†L123-L125】。
   - 再将进度更新为 100%(“加载完成”)【411489762169824†L126-L127】。
4. **完成或失败**：调用 `ValidateLoadedSeries()` 检查所有切片尺寸一致【411489762169824†L128-L132】。验证通过则调用 `CompleteLoading()`，否则调用 `FailLoading()`。

## 关键注意事项

- 像素数据必须在 `using` 块内提取，否则底层流可能已释放导致访问异常【411489762169824†L56-L80】。
- 由于加载过程是协程，UI 更新需要在 Unity 主线程上监听 `OnLoadingStatusChanged` 事件。
- 每次加载完成后会调用 `System.GC.Collect()` 主动触发垃圾回收，以释放内存【411489762169824†L134-L135】。

![加载循环示意图](./images/placeholder.png)
