# Loading 模块架构与流程概览

## 模块设计思路

Loading 模块是整个 DICOM 加载流程的协调者，它集成了索引解析、文件读取、像素提取、数据集验证、切片管理、体积属性设置以及状态通知等多个子系统。在调用者看来，它只暴露了两个主要接口：`StartLoading()` 用于启动加载任务，`StopLoading()` 用于取消正在进行的加载任务【818127251793982†L28-L51】。这些接口隐藏了底层的协程与资源管理细节，使得外部代码只需要关心启动和结束即可。

## 核心组成

Loading 模块由以下子功能组成：

- **索引解析**：通过 `LoadIndexFileCoroutine()` 读取或生成 JSON 索引文件，获得所有 DICOM 文件的相对路径列表【166205801724849†L30-L66】。索引文件缺失时会自动扫描目录生成一个简单列表【166205801724849†L70-L100】。
- **文件读取**：利用 `UnityWebRequest` 在协程中异步读取文本或二进制文件【726480524312695†L18-L43】【726480524312695†L46-L105】。可同时支持 StreamingAssets 下的相对路径和系统级的绝对路径。
- **DICOM 解析**：使用 FellowOakDicom 库打开二进制数据，验证数据集有效性，并提取第一帧像素数据【411489762169824†L40-L79】。验证逻辑检查像素尺寸、位深和帧长度，确保每个数据集都能正确解码【782507737950471†L18-L44】。
- **切片管理**：每个有效的 DICOM 文件都会转换为 `DicomSlice` 对象，并添加到目标 `DicomSeries` 容器；加载完成后会按位置排序切片【411489762169824†L104-L123】。
- **体积属性设置**：根据第一张切片推导体积尺寸、像素间距和原点【782507737950471†L55-L75】。
- **状态与事件**：通过基类的 `UpdateProgress()` 同步进度，并触发 `OnLoadingStatusChanged`、`OnLoadingComplete` 和 `OnLoadingFailed` 事件供 UI 层订阅【507239662329979†L77-L99】【507239662329979†L110-L147】。额外的 `OnLogMessage` 事件用于收集调试信息【201327181542954†L11-L27】。

## 流程概述

1. 调用 `StartLoading()`：初始化 `DicomSeries` 对象、重置状态，并启动内部协程【818127251793982†L38-L51】。
2. **读取索引**：协程首先调用 `LoadIndexFileCoroutine()` 读取索引文件，如果失败则尝试自动生成，并在生成失败时终止加载【166205801724849†L50-L66】。
3. **逐个加载切片**：遍历索引列表，依次读取每个文件的二进制数据，解析为 `DicomDataset`，验证有效性，提取像素数据，然后生成 `DicomSlice` 并添加到目标序列【411489762169824†L40-L95】。每隔数个切片更新一次进度【411489762169824†L104-L109】。
4. **结果整理**：全部切片加载完成后，检查是否至少加载了一张切片；如果没有则视为失败【411489762169824†L114-L117】。否则，对切片列表进行排序并设置体积属性【411489762169824†L120-L126】。
5. **验证与结束**：调用 `ValidateLoadedSeries()` 检查所有切片尺寸是否一致【782507737950471†L80-L98】。验证通过则触发完成事件，否则触发失败事件【411489762169824†L126-L132】。
6. **清理与取消**：在任何阶段，调用 `StopLoading()` 可以取消加载并释放资源【818127251793982†L55-L76】。

## 示例占位图

下面的示意图仅用于占位，请在完成教程时替换为实际的流程图或界面截图。

![加载流程示意图](./images/placeholder.png)
